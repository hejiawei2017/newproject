<wxs src="../../../wxs/HouseUtils.wxs" module="houseUtils" />
<wxs src="../../../wxs/DateUtils.wxs" module="dateUtils" />
<wxs src="../../../wxs/ImageUtils.wxs" module="imageUtils" />

<view class="page">
  <view class="flex space-between text">
    <view>订单号:{{ bookingDetail.bookingNumber }}</view>
    <view>{{ bookingDetail.bookingDate }}</view>
  </view>
  <view class="house-info container no-padding-top" catchtap="goToHouseDetail">
    <view class="left">
      <view class="title">{{ houseDetail.title }}</view>
      <view class='number-info'>
        <text class='tenant-info'>{{houseDetail.tenantNumber}}人·{{houseDetail.roomNumber}}室·{{houseDetail.bedNumber}}床·{{(houseDetail.publicToiletNumber || 0) + houseDetail.toiletNumber}}卫</text>
        <view class="stars-container" wx:if="{{ !isForeignCity }}">
          <stars value="{{ houseDetail.stars }}" />
        </view>
        <text class="comment-statis" wx:if="{{ !isForeignCity }}">{{ houseDetail.commentStatis }}</text>
      </view>
    </view>
    <view class="right">
      <image src="{{ imageUtils.processImage(houseDetail.houseImages[0].imagePath) }}" />
    </view>
  </view>
  <view wx:if="{{ isCanContactLoadlord }}" class="landlords container" catchtap="contactLoadlords">
    <view class="title">房东</view>
    <view class="info">
      <view>{{ houseDetail.landlord.nickName }}</view>
      <image src="https://oss.localhome.cn/new_icon/chart.png" />
    </view>
  </view>
  <view class="address container" catchtap="onOpenMapPage" wx:if="{{ !isForeignCity }}">
    <view class="title">地址</view>
    <view class="info">
      <view>{{ address }}</view>
    </view>
  </view>
  <view class="check-in-password container" wx:if="{{ !isForeignCity }}">
    <view class="title">入住密码</view>
    <view class="info">
      <view>{{ bookingDetail.doorPassword || '入住当天10点后可见' }}</view>
    </view>
  </view>
  <view class="check-in container">
    <view class="check-in-date">
      <view class="text">入住日期/时间</view>
      <view class="date">{{ dateUtils.setMonthDay(bookingDetail.checkinDate) }}<text>15:00</text></view>
    </view>
    <view class="days">{{days}}晚</view>
    <view class="check-in-date">
      <view class="text">退房日期/时间</view>
      <view class="date">{{ dateUtils.setMonthDay(bookingDetail.checkoutDate) }}<text>12:00</text></view>
    </view>
  </view>
  <view wx:if="{{ bookingDetail.guestViews && bookingDetail.guestViews.length > 0 }}" class="check-in-person container">
    <view class="title">入住人数<text class="person-count">{{ bookingDetail.guestViews.length }}人</text></view>
    <view class="info column">
      <view wx:for="{{ bookingDetail.guestViews }}" wx:key="guestId" class="item">
        <view>{{ item.name }}</view>
        <view>{{ item.cardNo }}</view>
      </view>
    </view>
    <view class="insurance" wx:if="{{ !isForeignCity }}">
      <image src="https://oss.localhome.cn/new_icon/insurance.png" />
      <text>Locals路客为以上入住人购买入住旅客意外伤害保险，最高赔付50万元，为您的出行人身安全保驾护航</text>
    </view>
  </view>
  <view class="fee container">
    <view class="title">费用</view>
    <view class="info column">
      <view class="item">
        <view>{{ days }}晚房费</view>
        <view>¥{{ bookingDetail.roomPrice }}</view>
      </view>
      <view wx:if="{{ bookingDetail.clearPrice > 0 }}" class="item">
        <view>清洁费</view>
        <view>¥{{ bookingDetail.clearPrice }}/次</view>
      </view>
      <view wx:if="{{ bookingDetail.buyMemberBagText }}" class="item">
        <view>{{ bookingDetail.buyMemberBagText }}</view>
        <view>￥{{ bookingDetail.memberBagPrice }} </view>
      </view>
      <view wx:if="{{ bookingDetail.deposit > 0 }}" class="item">
        <view>保证金<icon catchtap="showDepositTip" class="icon-gantan" /></view>
        <view>¥{{ bookingDetail.deposit }}</view>
      </view>
      <view wx:if="{{ bookingDetail.servicePrice > 0 }}" class="item">
        <view>预订服务费<icon catchtap="showServiceTip" class="icon-gantan" /></view>
        <view>¥{{ bookingDetail.servicePrice }}</view>
      </view>
      <view wx:if="{{ bookingDetail.invoiceServicePrice > 0 }}" class="item">
        <view>发票服务费<icon catchtap="showInvoiceTip" class="icon-gantan" /></view>
        <view>¥{{ bookingDetail.invoiceServicePrice }}</view>
      </view>
      <view wx:if="{{ bookingDetail.discountAmount > 0 }}" class="item">
        <view>会员折扣</view>
        <view class="minus-color">-¥{{ bookingDetail.discountAmount }}</view>
      </view>
      <view wx:if="{{ bookingDetail.couponAmount > 0 }}" class="item">
        <view>优惠券</view>
        <view class="minus-color">-¥{{ bookingDetail.couponAmount }}</view>
      </view>
      <view wx:if="{{ true }}" class="item space-between" wx:if="{{ !isForeignCity }}">
          <text class="key">50万住宿意外险</text>
          <text class="del-price flex-right">￥{{ accidentAmountTotal }}</text>
          <text class="minus-color">￥0</text>
      </view>
    </view>
  </view>
  <view class="total-fee container">
    <view class="title">订单金额<text class="total">￥{{ bookingDetail.originalPrice }}</text></view>
  </view>
  <view class="rule-section" wx:if="{{ !isForeignCity }}">
    <view class="rule-title">交易规则</view>
    <view class="rule-info">订单确认</view>
    <view class="rule-wrapper">下单后管家会与您联系确认行程并发送入住指引</view>
    <view class="rule-info">保证金</view>
    <view wx:if="{{ houseDetail.deposit && houseDetail.deposit !== 0 }}" class="rule-wrapper">路客将线上收取保证金{{houseDetail.deposit}}元，房客入住时请遵守管家制定的<text catchtap="toRules" class="role-click">房屋守则</text>，在退房后+1天内无提出损坏赔偿情况，将立即原路退还。</view>
    <view wx:else="{{ !houseDetail.deposit || houseDetail.deposit === 0 }}" class="rule-wrapper">本单您获得免收保证金的服务，请爱护好房间的设施和物品，如出现损坏或污迹，我们会向你追讨相关的复原费用。</view>
    <view class="rule-info">入住须知</view>
    <view class="rule-wrapper">
      <text wx:for="{{specialInfoList}}" wx:key="code">{{item.name}}{{specialInfoList.length === (index+1) ? '' : '、'}}</text>
    </view>
    <view wx:if="{{ bookingDetail.originalPrice !== 0 }}">
      <view class="rule-info" catchtap="goToUnsubscribe">
        <view style="margin-right: 10rpx;">退订政策</view>
        <icon class="icon-gantan" />
      </view>
      <time-line timeLineList="{{ timeLineList }}" currentStep="{{ currentStep }}" />
      <block wx:if="{{ isShowCancelOrder }}">
        <view class="cancel-order-button" catchtap="bookingCancel">取消订单</view>
      </block>
      <block wx:elif="{{ isShowRefundOrder }}">
        <view wx:if="{{ currentStep === 2 }}" class="cannot-refund">
          <view class="text">
            <text>入住中取消订单</text>
            <text>请联系在线客服</text>
          </view>
          <button open-type="contact" class="contact" session-from='7moor|{{userInfo.nickName}}|{{userInfo.avatar}}'>在线客服</button>
        </view>
        <view wx:elif="{{ currentStep < 2 }}" class="cancel-order-button" catchtap="bookingRefund">行程改变取消订单</view>
      </block>
      <view wx:elif="{{ refundPrice && bookingDetail.refundStatus == '6' }}" class="cannot-refund">
        <view class="text">
          <text>订单已取消</text>
          <text>退款状态：{{ refundPrice }}元退款中，预计3个工作日原路退回</text>
        </view>
        <button open-type="contact" class="contact" session-from='7moor|{{userInfo.nickName}}|{{userInfo.avatar}}'>在线客服</button>
      </view>
      <view wx:elif="{{ bookingDetail.refundStatus == '4' }}" class="cannot-refund">
        <view class="text">
          <text>订单已取消</text>
          <text>退款状态：已退款</text>
        </view>
        <button open-type="contact" class="contact" session-from='7moor|{{userInfo.nickName}}|{{userInfo.avatar}}'>在线客服</button>
      </view>
    </view>
    <view wx:elif="{{ bookingDetail.originalPrice === 0 }}">
      <view class="rule-info">
        <view style="margin-right: 10rpx;">退订政策</view>
      </view>
      <view class="cannot-refund price0">
        <view class="rule-wrapper">本订单使用优惠券抵扣支付订单全款，订单不可修改，不可取消。</view>
      </view>
    </view>
  </view>
  <view wx:if="{{ isForeignCity }}">
    <view wx:if="{{ OrderTradingRules }}" class="container">
      <view class="title">交易规则</view>
      <view class="info"><text>{{ OrderTradingRules }}</text></view>
    </view>
    <view wx:if="{{ OrderCheckInRules }}" class="container">
      <view class="title">入住须知</view>
      <view class="info"><text>{{ OrderCheckInRules }}</text></view>
    </view>
  </view>
  <view class="weight300 container menu-point" catch:tap="goToRule" wx:if="{{ !isForeignCity }}">
    房屋守则
    <icon class="icon-path float-right" />
  </view>
  <form wx:if="{{ displayPay }}" bindsubmit="nowBooking">
      <view class="footer {{ isFullScreen ? 'full-screen-bottom' : ''}}">
          <view class="footer-left">
            <view class="footer-price">
              <text wx:if="{{ isUseStoredMoney && payTotalPrice === 0 }}" class='total'>储值抵扣¥{{ bookingDetail.originalPrice }}</text>
                <text wx:else class='total'>¥{{ payTotalPrice }}<text class="use-strored-money" wx:if="{{ bookingDetail.useCash && bookingDetail.useCashMoney > 0 }}">(已用储值¥{{ bookingDetail.useCashMoney }})</text></text>
            </view>
            <text class='descript'><block wx:if="{{ preferentialAmount > 0 }}">已优惠¥{{ preferentialAmount }}</block><block wx:if="{{ bookingRequest.deposit > 0 }}">含{{ bookingRequest.deposit }}保证金</block></text>
          </view>
          <button class="footer-right" formType="submit" >{{ isUseStoredMoney && payTotalPrice === 0 ? '储值支付' : '前往支付' }}</button>
      </view>
  </form>
</view>
<im-message
  id="im-message"
  noAttached='{{false}}'
/>