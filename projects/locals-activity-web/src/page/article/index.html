<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Locals</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0, viewport-fit=cover">
    <!--<meta name="viewport" content="initial-scale=1.0, maximum-scale=1, user-scalable=no,viewport-fit=cover,width=device-width,height=device-height"/>-->
    <!-- UC强制竖屏 -->
    <meta name="screen-orientation" content="portrait">
    <!-- QQ强制竖屏 -->
    <meta name="x5-orientation" content="portrait">
    <!-- UC强制全屏 -->
    <meta name="full-screen" content="yes">
    <!-- QQ强制全屏 -->
    <meta name="x5-fullscreen" content="true">
    <!-- UC应用模式 -->
    <meta name="browsermode" content="application">
    <!-- QQ应用模式 -->
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="css/amazeui.min.css"/>
    <link rel="stylesheet" href="css/app.css"/>

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/amazeui.min.js"></script>
    <script type="text/javascript" src="js/load.js"></script>
    <script type="text/javascript" src="js/jquery.cityselect.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
 
</head>
<body class="bg">
<!--<img src="images/bg3.png" class="am-img-responsive">-->
<div class="content">

    <div class="top">
        <img src="images/title.png" class="am-img-responsive am-top-img">
    </div>
    <div class="center">
        <div class="am-bg-textbox">
            <input type="tel" maxlength="11" id="telPhone" class="am-form-field" placeholder="请输入手机号">
        </div>
        <div class="am-line">
            <div class="am-bg-textbox2">
                <input type="tel" maxlength="4" id="code" class="am-form-field" placeholder="请输入验证码">
            </div>
            <button onclick="getCode()" id="btnValCode" class="am-btn-code">发送验证码</button>
            <div style="clear:both"></div>
        </div>
    </div>
    <div class="bottom">
        <button id="btnSubmit" class="am-btn-submit"></button>
    </div>

    <div data-am-modal="{target: '#your-modal', closeViaDimmer: 0}" class="am-detail"></div>
</div>
<div class="am-modal am-modal-no-btn" tabindex="-1" id="your-modal">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">
            <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
        </div>
        <img style="margin-top: -1rem;" src="images/tanchaung2.png" class="am-img-responsive">
    </div>
</div>

<div class="am-modal am-modal-no-btn" tabindex="-1" id="coupon-modal">
    <div class="am-modal-dialog am-with15">
        <div class="am-modal-hd">
            <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
        </div>
        <div class="am-with15">
            <img style="width: 15rem;height: 20rem;" src="images/tanchuang.png" class="am-img-responsive">
            <div id="coupon-text" class="am-coupon"></div>
            <button id="btnLocals" class="am-coupon-btn"></button>
            <div class="am-text" id="btnInfo">了解五折券使用方法</div>
        </div>

    </div>
</div>
<div class="end-mask">
    <p>活动已结束，去微信搜索“路客精品民宿预定”小程序获取跟多优惠吧</p>
</div>
</body>
</html>
<script type="text/javascript">
    (function () {
        window.onresize = function () {
            setRootFontSize();
        };
        setRootFontSize();

        function setRootFontSize() {
            var el = document.documentElement;
            var w = el.clientWidth;
            // 最大按6Plus，最小按240，因为小于12px可能就有问题了
            if (w > 1024) {
                w = 1024;
            } else if (w < 240) {
                w = 240;
            }
            el.style.fontSize = w / 20 + 'px';
        }
    })();
</script>
<script>
    var maxtime = 0;  //5分钟
    var timer;
    var isPass = true;
    var code;
    var codePass = true;

    function getCode() {
        codePass = false;
        var strPhone = $("#telPhone").val().trim();
        if (strPhone == "") {
            showMsg("请输入手机号码", "bottom");
            return false;
        }
        if (!isPhoneNo(strPhone)) {
            showMsg('请输入正确的手机号码！', "bottom");
            return false;
        }
        var codeData = {
            "phone": $("#telPhone").val()
        };
        $.ajax({
            type: 'POST',
            url: "http://ms.localhome.cn/api/wechat/five-plus/code",
            data: JSON.stringify(codeData),
            dataType: 'text',
            contentType: "application/json",
            success: function (res) {
                console.log($.parseJSON(res));
                var result = $.parseJSON(res).success;
                if (result == true ) {
                    code = $.parseJSON(res).data.code;
                    maxtime = 5 * 60;  //5分钟
                    timer = setInterval("SetTimePopVal()", 1000);
                } else {
                    codePass = true;
                    code = "";
                    $("#btnValCode").text("重新发送");
                    // $("#btnValCode").attr("onclick", "getCode()");
                    // showMsg("验证码发送失败，请重新发送", "bottom");
                }

            },
            fail: function () {
                codePass = true;
                code = "";
                // $("#btnValCode").attr("onclick", "getCode()");
                // showMsg("服务器连接error", "bottom");
            }
        });
    }

    function SetTimePopVal() {
        if (maxtime >= 0) {
            minutes = Math.floor(maxtime / 60);
            seconds = Math.floor(maxtime % 60);

            if ($("#btnValCode").text() != "重新发送" || $("#btnValCode").text() != "点击发送") {
                $("#btnValCode").text(maxtime);
                $("#btnValCode").attr("onclick", "");
            }
            --maxtime;
        } else {
            clearInterval(timer);
            $("#btnValCode").text("重新发送");
            $("#btnValCode").attr("onclick", "GetValidCode()");
        }
    }

    function isPhoneNo(phone) {
        var pattern = /^1[345789]\d{9}$/;
        return pattern.test(phone);
    }

    $(function () {
        $("#coupon-text").text("");
        $("#btnSubmit").click(function () {
            var cstMobile = $("#telPhone").val().trim();
            var strVCode = $("#code").val().trim();

            if (cstMobile == "") {
                showMsg("请输入手机号码", "bottom");
                return false;
            }

            if (!isPhoneNo(cstMobile)) {
                showMsg('请输入正确的手机号码！', "bottom");
                return false;
            }

            if (strVCode.trim() == "") {
                showMsg('请输入验证码！', "bottom");
                return false;
            }

            if (isPass) {
                isPass = false;
                var sendData = {
                    "cstMobile": cstMobile,
                    "cstName": "内容",
                    "strVCode": strVCode
                };
                $.ajax({
                    type: 'POST',
                    url: "http://ms.localhome.cn/api/wechat/five-plus/send",
                    data: JSON.stringify(sendData),
                    dataType: 'text',
                    contentType: "application/json",
                    success: function (res) {
                        if ($.parseJSON(res).success == true) {
                            $("#coupon-text").text($.parseJSON(res).data.couponCode);
                            $('#coupon-modal').modal();
                        } else {
                            isPass = true;
                            showMsg($.parseJSON(res).errorDetail, "bottom");
                        }

                    },
                    fail: function () {
                        isPass = true;
                        showMsg("服务器连接error", "bottom");
                    }
                });

            }
        });


        $("#btnLocals").click(function () {
            window.location.href = "http://wxpt.localhome.cn";
        });

        $("#btnInfo").click(function () {
            window.location.href = "http://wxpt.localhome.cn/Activity/HalfoffInfo";
        });


    })


</script>

<script>
    var appId, timestamp, nonceStr, signature = "";

    $(function () {
        $.ajax({
            type: 'POST',
            url: "http://ms.localhome.cn/api/wechat/five-plus/config",
            contentType: "application/json",
            success: function (res) {
                if (res.success == true) {
                    appId = res.data.appId;
                    timestamp = res.data.timestamp;
                    nonceStr = res.data.nonceStr;
                    signature = res.data.nonceStr;
                }

            },
            fail: function () {
                showMsg("服务器连接error", "bottom");
            }
        });

        wx.config({
            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId: appId, // 必填，公众号的唯一标识
            timestamp: timestamp, // 必填，生成签名的时间戳
            nonceStr: nonceStr, // 必填，生成签名的随机串
            signature: signature,// 必填，签名
            jsApiList: [
                'checkJsApi',
                'hideMenuItems',
                'showMenuItems',
                'hideAllNonBaseMenuItem',
                'showAllNonBaseMenuItem',
                'hideOptionMenu',
                'showOptionMenu',
                'closeWindow',
                'onMenuShareTimeline',
                'onMenuShareAppMessage',
                'previewImage',
                'chooseImage',
                'uploadImage',
                'downloadImage'
            ] // 必填，需要使用的JS接口列表
        });
        wx.ready(function () {
            var shareUrl = window.location.href;
            var shareImg = 'http://min.localhome.cn/Content/images/logo_share.jpg';
            var desc = "全国50+城市，10000+民宿任意住";
            var title = "五一精品民宿五折住，首单减免500元";


            wx.onMenuShareTimeline({
                title: title,
                link: shareUrl,
                imgUrl: shareImg,
                success: function () {
                }
            })
            wx.onMenuShareAppMessage({
                title: title,
                desc: desc,
                link: shareUrl,
                imgUrl: shareImg, // 分享图标
                type: '',
                dataUrl: '',
                success: function () {
                }
            });

        });

    })

</script>