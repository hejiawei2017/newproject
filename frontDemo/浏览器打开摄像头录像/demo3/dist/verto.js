!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Verto=e():t.Verto=e()}(window,(function(){return function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=1)}([function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.generateGUID=e.VertoBase=void 0;const i=void 0!==window.crypto&&void 0!==window.crypto.getRandomValues?function(){let t=new Uint16Array(8);window.crypto.getRandomValues(t);let e=function(t){let e=t.toString(16);for(;e.length<4;)e="0"+e;return e};return e(t[0])+e(t[1])+"-"+e(t[2])+"-"+e(t[3])+"-"+e(t[4])+"-"+e(t[5])+e(t[6])+e(t[7])}:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))};e.generateGUID=i;e.VertoBase=class{constructor(t){this.event_handlers={},this.debug=t}subscribeEvent(t,e){let s=i();return this.event_handlers[t]||(this.event_handlers[t]=[]),this.event_handlers[t].push({id:s,code:e}),s}unsubscribeEvent(t,e){this.event_handlers[t]=e?this.event_handlers[t].map((t,s,i)=>t.id==e?void 0:t):[]}dispatchEvent(t,e){if(this.debug&&console.log("Dispatch",t,e),this.event_handlers[t])for(let s of this.event_handlers[t])s.code(e)}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CallDirection=e.Verto=void 0;const i=s(2),n=s(3);Object.defineProperty(e,"CallDirection",{enumerable:!0,get:function(){return n.CallDirection}});const o=s(0);class c extends o.VertoBase{constructor(t,e,s,i,c,r,a){super(a),this.id=i||o.generateGUID(),this.options=c||{},this.direction=s?n.CallDirection.Outgoing:n.CallDirection.Incoming,this.rtc=new n.VertoRtc(t,this.direction,r,a),this.rpc=e,this.rtc.subscribeEvent("send-offer",t=>{let e=Object.assign({},this.options);e=Object.assign(e,{destination_number:s,callID:this.id}),this.rpc.call("verto.invite",{dialogParams:e,sdp:t.sdp},t=>{},t=>{})}),this.rtc.subscribeEvent("send-answer",t=>{this.rpc.call("verto.answer",{dialogParams:{destination_number:s,callID:this.id},sdp:t.sdp},t=>{},t=>{})}),this.rtc.subscribeEvent("track",t=>{this.dispatchEvent("track",t)})}onAnswer(t){t&&this.rtc.onMedia(t),this.debug&&console.log("answer"),this.dispatchEvent("answer")}onMedia(t){this.rtc.onMedia(t),this.dispatchEvent("media")}addTrack(t){this.rtc.addTrack(t)}preSdp(t){this.rtc.preSdp(t)}answer(t){this.rtc.answer(t)}hangup(t={}){this.rpc.call("verto.bye",Object.assign({dialogParams:{callID:this.id}},t),t=>{},t=>{}),this.clear()}clear(){this.dispatchEvent("bye",this)}dtmf(t){this.rpc.call("verto.info",{dtmf:t.toString(),dialogParams:{callID:this.id}},t=>{},t=>{})}hold(t){this.rpc.call("verto.modify",{action:"hold",dialogParams:Object.assign(Object.assign({callID:this.id},this.options),t)},t=>{"held"===t.holdState?(this.holdStatus=!0,this.dispatchEvent("hold",this)):(this.holdStatus=!1,this.dispatchEvent("unhold",this))},t=>{})}unhold(t){this.rpc.call("verto.modify",{action:"unhold",dialogParams:Object.assign(Object.assign({callID:this.id},this.options),t)},t=>{"held"===t.holdState?(this.holdStatus=!0,this.dispatchEvent("hold",this)):(this.holdStatus=!1,this.dispatchEvent("unhold",this))},t=>{})}toggleHold(t){this.rpc.call("verto.modify",{action:"toggleHold",dialogParams:Object.assign(Object.assign({callID:this.id},this.options),t)},t=>{"held"===t.holdState?(this.holdStatus=!0,this.dispatchEvent("hold",this)):(this.holdStatus=!1,this.dispatchEvent("unhold",this))},t=>{})}}class r extends o.VertoBase{constructor(t){super(t.debug),this.calls={},this.logged_in=!1,this.options=t,this.rpc=new i.JsonRpcClient(t.transportConfig,t.debug),this.rpc.setEventHandler((t,e)=>{switch(t){case"verto.answer":{let t=e.callID;this.calls[t].onAnswer(e.sdp);break}case"verto.media":{let t=e.callID;this.calls[t].onMedia(e.sdp);break}case"verto.invite":{let t=new c(this.options.rtcConfig,this.rpc,"",e.callID,{caller_id_name:e.caller_id_name,caller_id_number:e.caller_id_number},this.options.ice_timeout,this.options.debug);t.preSdp(e.sdp),this.calls[e.callID]=t,this.dispatchEvent("invite",t);break}case"verto.bye":this.calls[e.callID].clear(),delete this.calls[e.callID];break}}),this.rpc.setReconnectHandler(()=>{this.logged_in&&this.login()}),this.options.rtcConfig=Object.assign({},this.options.rtcConfig||{})}login(){return new Promise((t,e)=>{this.rpc.call("login",{login:this.options.transportConfig.login,passwd:this.options.transportConfig.passwd},e=>{this.sessid=e.sessid,this.logged_in=!0,t(e)},t=>{e(t)})})}call(t,e,s){let i=new c(this.options.rtcConfig,this.rpc,e,o.generateGUID(),s,this.options.ice_timeout,this.options.debug);for(let e of t)i.addTrack(e);return this.calls[i.id]=i,i}isLogged(){return this.logged_in}logout(){this.calls&&Object.keys(this.calls).forEach(t=>{this.calls[t].hangup()}),this.rpc.close(),this.rpc=null,this.sessid=null,this.logged_in=!1}}e.Verto=r},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.JsonRpcClient=void 0;e.JsonRpcClient=class{constructor(t,e){this.request_id=1,this.queue=[],this.callbacks=[],this.debug=!1,this.debug=e,this.options=Object.assign({},t)}initSocket_(){this.socket_=new WebSocket(this.options.socketUrl),this.socket_.onmessage=this.onMessage.bind(this),this.socket_.onclose=()=>{setTimeout(()=>{this.debug&&console.log("WSS reconnect"),this.initSocket_()},1e3)},this.socket_.onopen=()=>{let t="";for(this.reconnectHandler&&this.reconnectHandler();t=this.queue.pop();)this.socket.send(t)}}closeSocket_(){this.socket_.onclose=()=>{console.log("WebSocket is closed now.")},this.socket_.close()}get socket(){return this.socket_||this.initSocket_(),this.socket_}onMessage(t){let e;try{e=JSON.parse(t.data)}catch(t){}if(this.debug&&console.log(e),"object"==typeof e&&"jsonrpc"in e&&"2.0"===e.jsonrpc)if("method"in e)this.eventHandler(e.method,e.params);else if("result"in e&&this.callbacks[e.id]){let t=this.callbacks[e.id].success_cb;delete this.callbacks[e.id],t(Object.assign({},e.result))}else if("error"in e&&this.callbacks[e.id]){let t=this.callbacks[e.id].error_cb,s=Object.assign({},this.callbacks[e.id]);delete this.callbacks[e.id],-32e3==e.error.code&&this.options.login&&this.options.passwd?this.call("login",{login:this.options.login,passwd:this.options.passwd,loginParams:this.options.loginParams,userVariables:this.options.userVariables},t=>{this.socketCall_(s)},s=>{t(Object.assign({},e.result))}):t(Object.assign({},e.result))}}socketCall_({request:t,success_cb:e,error_cb:s}){t.id=this.request_id++;let i=JSON.stringify(t);this.callbacks[t.id]={request:t,success_cb:e,error_cb:s},this.socket.readyState<1?(this.queue.push(i),this.debug&&console.log("Queued",i)):(this.socket.send(i),this.debug&&console.log("Sent",i))}setEventHandler(t){this.eventHandler=t}setReconnectHandler(t){this.reconnectHandler=t}call(t,e,s,i){let n={jsonrpc:"2.0",method:t,params:Object.assign({},e),id:0};this.socket&&this.socketCall_({request:n,success_cb:s,error_cb:i})}close(){this.queue=[],this.callbacks=[],this.eventHandler=null,this.reconnectHandler=null,this.closeSocket_()}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CallDirection=e.VertoRtc=void 0;const i=s(0);var n,o;!function(t){t[t.Incoming=0]="Incoming",t[t.Outgoing=1]="Outgoing"}(n||(n={})),e.CallDirection=n,function(t){t[t.None=0]="None",t[t.Schedulled=1]="Schedulled",t[t.MessageSent=2]="MessageSent"}(o||(o={}));class c extends i.VertoBase{constructor(t,e,s,i){super(i),this.state=o.None,this.direction=n.Incoming,this.ice_timeout=s||3e3,t.iceCandidatePoolSize="iceCandidatePoolSize"in t?t.iceCandidatePoolSize:1,this.pc=new RTCPeerConnection(t),this.pc.ontrack=this.onTrack.bind(this),this.pc.onnegotiationneeded=this.onNegotiation.bind(this),this.pc.onicecandidate=this.onCandidate.bind(this),this.pc.onicegatheringstatechange=this.onIceGatheringStateChange.bind(this),void 0!==e&&(this.direction=e)}onTrack(t){this.dispatchEvent("track",t.track)}onCandidate(t){}onIceGatheringStateChange(t){if("complete"==this.pc.iceGatheringState){if(this.ice_timer&&clearTimeout(this.ice_timer),this.state==o.MessageSent)return;this.direction?this.dispatchEvent("send-offer",this.pc.localDescription):this.dispatchEvent("send-answer",this.pc.localDescription)}}iceTimerTriggered(){this.debug&&console.log(this.pc),this.state==o.Schedulled&&(this.state=o.MessageSent,this.direction?this.dispatchEvent("send-offer",this.pc.localDescription):this.dispatchEvent("send-answer",this.pc.localDescription))}onNegotiation(){this.pc.createOffer().then(t=>(this.ice_timer=setTimeout(this.iceTimerTriggered.bind(this),this.ice_timeout),this.pc.setLocalDescription(t))).then(()=>{this.state=o.Schedulled}).catch(t=>{})}onMedia(t){this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:t})).then(()=>{this.debug&&console.log("got remote media")}).catch(t=>{this.debug&&console.log("remote media error",t)})}preSdp(t){this.presdp=t}addTrack(t){this.pc.addTrack(t)}answer(t){for(let e of t)this.pc.addTrack(e);this.ice_timer=setTimeout(this.iceTimerTriggered.bind(this),this.ice_timeout),this.pc.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:this.presdp})).then(()=>{this.pc.createAnswer().then(t=>{this.pc.setLocalDescription(t),this.state=o.Schedulled})})}}e.VertoRtc=c}])}));
//# sourceMappingURL=verto.js.map